pipeline {
    agent { label 'agent-ssh' }
    environment {
      MY_KUBECONFIG = credentials('ocp46')
      REGISTRY_URL = "registry.apps.ocp45.lab.kx.com"
      IMAGE_NAME    = "amkrtichyan/rockylinux"
      IMAGE_TAG     = "aws"
      
    }
    stages {
        stage('Build') {
            steps {
              script {
                sh "id"
                sh """
                podman build -t $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG rockylinux/
                """
              }
            }
        }

	stage('Login to Registry') {
	    steps {
		script {
		    withCredentials([usernamePassword(
			credentialsId: 'nexus-registry-creds', 
			usernameVariable: 'REG_USER',
			passwordVariable: 'REG_PASS'
		    )]) {
			sh """
			echo "$REG_PASS" | podman login $REGISTRY_URL -u "$REG_USER" --password-stdin
			"""
		    }
		}
	    }
	}

	stage('Push the Image') {
	    steps {
		echo 'Pushing..'
                sh ("podman push $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG")
	    }
	}
	stage('Deploy') {
	    steps {
		echo 'Deploying....'
	    }
	}
    }
}
