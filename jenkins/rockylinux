pipeline {
    agent { label 'agent-ssh' }
    environment {
      MY_KUBECONFIG = credentials('ocp46')
      REGISTRY_URL = "registry.apps.ocp45.lab.kx.com"
      IMAGE_NAME    = "amkrtichyan/rockylinux"
      IMAGE_TAG     = "aws"
      NEXUS_CREDS = credentials('nexus-registry-creds') 
    }
    stages {
        stage('Build') {
            steps {
              script {
                sh "id"
                sh """
                podman build -t $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG rockylinux/
                """
              }
            }
        }

	stage('Login to Registry') {
	    steps {
                sh('podman login $REGISTRY_URL -u $NEXUS_CREDS_USR -p $NEXUS_CREDS_PSW')     
	    }
	}

	stage('Push the Image') {
	    steps {
                sh ("podman push $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG")
	    }
	}
	stage('Deploy') {
	    steps {
		echo 'Deploying....'
	    }
	}
    }

    post {
        always {
            sh "podman logout $REGISTRY_URL"
        }
    }
}
